<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Infinite Scrolling Card System</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="card">
    <canvas id="canvas1"></canvas>
  </div>
  <div class="card"></div>
  <div class="card">
    Card1
  </div>
</div>

<!-- Account info circle and menu -->
<div class="account-info" id="accountInfo">AI</div>
<div class="account-menu" id="accountMenu">
  <a href="#" id="likedJobs">Liked Jobs</a>
  <a href="#" id="accountInfoMenu">Account Info</a>
  <a href="#" id="authAction"></a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
  import { getAuth, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";
  import { firebaseConfig } from "./firebase-config.js";

  // Initialize Firebase
  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const firestore = getFirestore(firebaseApp);

  // Set persistence to local
  setPersistence(auth, browserLocalPersistence).then(() => {
    // DOM elements
    const accountInfo = document.getElementById('accountInfo');
    const accountMenu = document.getElementById('accountMenu');
    const likedJobs = document.getElementById('likedJobs');
    const accountInfoMenu = document.getElementById('accountInfoMenu');
    const authAction = document.getElementById('authAction');

    // Toggle account menu
    accountInfo.addEventListener('click', () => {
      accountMenu.style.display = accountMenu.style.display === 'block' ? 'none' : 'block';
    });

    // Add functionality to menu items
    likedJobs.addEventListener('click', () => {
      // Redirect to liked jobs page
      window.location.href = 'liked-jobs.html';
    });

    accountInfoMenu.addEventListener('click', () => {
      // Redirect to account info page
      window.location.href = 'account-info.html';
    });

    // Authentication action (login/logout)
    authAction.addEventListener('click', () => {
      if (auth.currentUser) {
        // User is signed in, perform sign out
        signOut(auth).then(() => {
          alert('Signed out successfully!');
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error('Error signing out: ', error);
          alert('Sign-out failed. Please try again.');
        });
      } else {
        // User is signed out, redirect to login page
        window.location.href = 'login.html';
      }
    });

    // Listen for authentication state changes
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is signed in, fetch user data from Firestore
        const userRef = doc(firestore, 'users', user.uid);
        getDoc(userRef).then((docSnap) => {
          if (docSnap.exists()) {
            const userData = docSnap.data();
            accountInfo.style.backgroundImage = `url(${userData.photoURL})`;
            accountInfo.textContent = '';
            authAction.textContent = 'Log Out';
          } else {
            console.log('No such document!');
          }
        }).catch((error) => {
          console.log('Error getting document:', error);
        });
      } else {
        // User is signed out
        accountInfo.style.backgroundImage = '';
        accountInfo.textContent = 'AI';
        authAction.textContent = 'Log In';
      }
    });

    // Close menu if clicked outside
    window.addEventListener('click', (event) => {
      if (!accountInfo.contains(event.target) && !accountMenu.contains(event.target)) {
        accountMenu.style.display = 'none';
      }
    });
  }).catch((error) => {
    console.error('Error setting persistence: ', error);
  });
</script>
</body>
</html>
